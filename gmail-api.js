class GmailAPI{constructor(t){this.t=t;this.base='https://www.googleapis.com/gmail/v1/users/me';this.lc={};}async req(ep,o={}){const r=await fetch(this.base+ep,{...o,headers:{'Authorization':'Bearer '+this.t,'Content-Type':'application/json',...(o.headers||{})}});if(!r.ok){const t=await r.text();throw new Error('Gmail '+r.status+': '+t);}return r.json();}async listMessages(q,max=50){const d=await this.req('/messages?q='+encodeURIComponent(q)+'&maxResults='+max);return d.messages||[];}async getMessage(id){return await this.req('/messages/'+id+'?format=full');}parseEmailData(m){const hs=m.payload?.headers||[];const h=n=>(hs.find(x=>x.name.toLowerCase()===n.toLowerCase())||{}).value||'';const atts=[];if(m.payload?.parts)for(const p of m.payload.parts)if(p.filename&&p.filename.length>0)atts.push({filename:p.filename,mimeType:p.mimeType,size:p.body?.size||0,attachmentId:p.body?.attachmentId||null});return{id:m.id,from:h('From'),to:h('To'),subject:h('Subject'),date:h('Date'),snippet:m.snippet||'',body:this.extractBody(m.payload),attachments:atts,headers:hs};}extractBody(p){if(!p)return'';if(p.body?.data)return this.dec(p.body.data);if(p.parts){for(const x of p.parts)if(x.mimeType==='text/plain'&&x.body?.data)return this.dec(x.body.data);for(const x of p.parts)if(x.mimeType==='text/html'&&x.body?.data)return this.stripHtml(this.dec(x.body.data));for(const x of p.parts)if(x.parts){const r=this.extractBody(x);if(r)return r;}}return'';}dec(d){try{return decodeURIComponent(atob(d.replace(/-/g,'+').replace(/_/g,'/')).split('').map(c=>'%'+('00'+c.charCodeAt(0).toString(16)).slice(-2)).join(''));}catch(e){try{return atob(d.replace(/-/g,'+').replace(/_/g,'/'));}catch(e2){return d;}}}stripHtml(h){return h.replace(/<br\s*\/?>/gi,'\n').replace(/<\/p>/gi,'\n\n').replace(/<[^>]+>/g,'').replace(/&nbsp;/g,' ').replace(/&amp;/g,'&').replace(/&lt;/g,'<').replace(/&gt;/g,'>').replace(/&quot;/g,'"').trim();}async getAttachment(mid,aid){const d=await this.req('/messages/'+mid+'/attachments/'+aid);return d.data?this.dec(d.data):'';}async listLabels(){const d=await this.req('/labels');return d.labels||[];}async ensureLabel(name){if(this.lc[name])return this.lc[name];const labels=await this.listLabels();const parts=name.split('/');let path='';for(let i=0;i<parts.length;i++){path=parts.slice(0,i+1).join('/');const ex=labels.find(l=>l.name===path);if(ex){this.lc[path]=ex.id;continue;}try{const cr=await this.req('/labels',{method:'POST',body:JSON.stringify({name:path,labelListVisibility:'labelShow',messageListVisibility:'show'})});this.lc[path]=cr.id;labels.push(cr);}catch(e){const rf=await this.listLabels();const f=rf.find(l=>l.name===path);if(f)this.lc[path]=f.id;else throw e;}}return this.lc[name];}async addLabel(mid,ln){const lid=await this.ensureLabel(ln);if(!lid)throw new Error('Label '+ln+' nenalezen');return await this.req('/messages/'+mid+'/modify',{method:'POST',body:JSON.stringify({addLabelIds:[lid]})});}}export default GmailAPI;
