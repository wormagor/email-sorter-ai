class AIEngine{constructor(s){this.s=s||{};}async classify(e,att,rules){const p=this.s.aiProvider||'openai',pr=this.prompt(e,att,rules);if(p==='openai')return await this.openai(pr);if(p==='claude')return await this.claude(pr);throw new Error('Neznamy provider');}prompt(e,att,rules){const l=(rules||[]).map(r=>r.name+': '+r.label).join('\n');let c='Od: '+(e.from||'')+'\nPredmet: '+(e.subject||'')+'\nObsah: '+(e.body||e.snippet||'').substring(0,2000);if(att)c+='\nPrilohy:\n'+att.substring(0,1000);return'Analyzuj email.\nKategorie:\n'+l+'\n\nEmail:\n'+c+'\n\nJSON: {"label":"...","name":"...","confidence":0-1,"reason":"..."}';}async openai(pr){const k=this.s.openaiKey;if(!k)throw new Error('OpenAI klic chybi');const m=this.s.openaiModel||'gpt-4o-mini';const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+k},body:JSON.stringify({model:m,messages:[{role:'system',content:'JSON odpovedi.'},{role:'user',content:pr}],temperature:.3,max_tokens:500})});if(!r.ok)throw new Error('OpenAI '+r.status);const d=await r.json();return this.parse(d.choices?.[0]?.message?.content,'openai');}async claude(pr){const k=this.s.claudeKey;if(!k)throw new Error('Claude klic chybi');const m=this.s.claudeModel||'claude-sonnet-4-20250514';const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':k,'anthropic-version':'2023-06-01'},body:JSON.stringify({model:m,max_tokens:500,messages:[{role:'user',content:pr}]})});if(!r.ok)throw new Error('Claude '+r.status);const d=await r.json();return this.parse(d.content?.[0]?.text,'claude');}parse(c,src){try{const m=(c||'').match(/\{[\s\S]*\}/);if(!m)return{label:null,confidence:0,source:src};const p=JSON.parse(m[0]);return{label:p.label||null,name:p.name||'AI',confidence:parseFloat(p.confidence)||0,reason:p.reason||'',source:src};}catch(e){return{label:null,confidence:0,source:src};}}}export default AIEngine;
